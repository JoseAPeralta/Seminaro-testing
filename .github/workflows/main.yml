name: _minify

on:
  workflow_call:
    inputs:
      js_path:
        type: string
        required: false
        default: "script.js"
      css_path:
        type: string
        required: false
        default: "style.css"
      artifact_name:
        type: string
        required: false
        default: "site-minified"

jobs:
  minify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Copiar sitio a site/ (staging)
        run: |
          mkdir -p site
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.lighthouseci' \
            --exclude='report' \
            ./ site/

      - name: Minificar (sobrescribe mismo nombre dentro de site/)
        run: |
          JS="site/${{ inputs.js_path }}"
          CSS="site/${{ inputs.css_path }}"

          if [ ! -f "$JS" ]; then echo "No existe $JS"; exit 1; fi
          if [ ! -f "$CSS" ]; then echo "No existe $CSS"; exit 1; fi

          # JS
          npx --yes terser "$JS" -o "$JS" -c -m

          # CSS
          npx --yes -p clean-css-cli cleancss -o "${CSS}.tmp" "$CSS"
          mv "${CSS}.tmp" "$CSS"

      - name: Subir artifact con el sitio minificado
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: site
          retention-days: 7
